<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>monitor Ethereum balance and transactions</title>
    <script
      type="text/javascript"
      src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.3/jquery.min.js"
    ></script>
    <script type="text/javascript" src="web3.min.js"></script>

    <script type="text/javascript">
      var ws;
      var socketurl;
      var ethAddr;

      // this is important as borwser will reject ws call if it is a https page
      if (location.protocol === "https:") {
        socketurl = "wss://";
      } else {
        socketurl = "ws://";
      }

      socketurl += "localhost:8546";

      $().ready(function() {
        if (typeof web3 !== "undefined") {
          console.warn(
            "Using web3 detected from external source like Metamask"
          );
          // Use Mi0xa86e0a5ab51612e245fa96461cfc7df3129595950xa86e0a5ab51612e245fa96461cfc7df312959595st/MetaMask's provider
          window.web3 = new Web3(web3alert.currentProvider);
        } else {
          console.warn(
            "No web3 detected. Falling back to http://localhost:8545"
          );
          // fallback - use your fallback strategy (local node / hosted node + in-dapp id mgmt / fail)
          window.web3 = new Web3(
            new Web3.providers.HttpProvider("http://localhost:8545")
          );
        }

        // get the Etherum address from URL
        var qPara = new URLSearchParams(window.location.search);
        if (qPara.has('addr')) {
          ethAddr = qPara.get('addr');
          $("#addr").text(ethAddr);
        }        
        if (typeof ethAddr !== "undefined") {
          $("#spanStatus").text("connecting");
          ws = new WebSocket(socketurl);

          ws.onopen = function() {
            $("#spanStatus").text("Connected to geth at " + socketurl + "");

            // subscribe through websocket
            ws.send(
              '{"id": 1, "method": "eth_subscribe", "params": ["newHeads", {}]}'
            );
            // latest balance
            setInterval(() => {
              $("#balance").text(
                web3.fromWei(web3.eth.getBalance(ethAddr), "ether").toString()
              );
            }, 1000);

            // literally get all blocks
            let lastTimeStamp;
            setInterval(() => {
              let obj = web3.eth.getBlock("latest");
              if (obj.timestamp != lastTimeStamp) {
                $("#chain").append(`<li>` + obj.timestamp + `</li>`);
                lastTimeStamp = obj.timestamp;
              }
            }, 1000);

            //get my own ID
            let myID = web3.eth.coinbase;

            function sendTo(id) {
              let tact={
                from: myID,
                to: id,
                value: 1,
                data: "0x123412387461287346892173"
              };
              let tx2=web3.eth.signTransaction(tact,myID);
              web3.eth.sendSignedTransaction(tx2.raw);
            }

            //send ether to people when payment is recorded
            $("#sendee").on("keyup", e => {
              if (e.key == "Enter") {
                sendTo($("#sendee")[0].value);
              }
            });
          };

          ws.onclose = function() {
            var d = new Date();
            $("#spanStatus").text("Unable to connect to geth");
          };
        }

        $(window).bind("beforeunload", function() {
          ws.close();
        });
      });
    </script>

    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <h1>DASHBOARD</h1>
    <div style="display:flex;flex-direction:row;">
      <div style="flex: 1 1 auto">
        <h2>Status:<span id="spanStatus">Disconnected</span></h2>
        <h2>Mining reward/sec:<span>AMOUNT</span></h2>
        <h2>Account: <span id="addr"></span></h2>
        <h2>Balance: <span id="balance">...</span></h2>
        <h2>Add Sendee: <input id="sendee" /></h2>
      </div>
      <div style="flex: 1 1 auto">
        <h2>Block list...</h2>
        <div
          style="display:flex;flex-direction:column; overflow-y:auto"
          id="chain"
        ></div>
      </div>
    </div>
  </body>
</html>